# `TML-CTP`

`TML-CTP` project aims to depersonalize imaging data. It is developed by the Translational Machine Learning Lab at the Lausanne University Hospital for internal use as well as for open-source software distribution.

## Description

It dockerizes the Dicom Anonymizer Tool (DAT) of the Clinical Trial Processor (CTP), and provides:
- a Python package to batch the anonymization process via the Docker image
- a few template scripts for DAT.

**DISCLAIMER: The few template scripts are only provided for testing TMP-CTP with your application. They are not intended to be used in a clinical or research setting, and should be considered incomplete test samples. DICOM files filtered through this program and associated scripts are not guaranteed to be free of Protected Health Information (PHI).**

## Pre-requisites

`TML-CTP` relies on the two main tools that has to be installed a-priori:

- `Docker`: Software containeization engine (See [Installation instructions](https://docs.docker.com/engine/install/))
- `Python 3.10` with `pip`
- `make`: used to ease the build of the Docker image (See [official docs](https://www.gnu.org/software/make/))

Note that `make` is a Linux tool. If you are on Windows, you will have to use the Windows Subsystem for Linux (WSL). See [WSL Installation instructions](https://learn.microsoft.com/en-us/windows/wsl/install).

## Installation

Installation of `TML-CTP` consists of three steps:

1. Clone this repository locally::

     cd <preferred-installation-directory>
     git clone git@github.com:TranslationalML/tml-ctp.git
     cd tml-ctp
   
2. Build the Docker image with `make`::

    make build-docker

3. In your Python 3.10 environment, install the Python package with `pip`::

   pip install .

  This will installed all Python dependencies along with the main `ctp_dat_batcher` script and a few other utility scripts.

You should be ready to test `TML-CTP`!ðŸš€ 

## How to use the `ctp_dat_batcher`

### Usage

```output
usage: ctp_dat_batcher [-h] -i INPUT_FOLDERS -o OUTPUT_FOLDER -s DAT_SCRIPT [--new-ids NEW_IDS] [--day-shift DAY_SHIFT]

Run DAT.jar (CTP DicomAnonymizerTool) with Docker to anonymize DICOM files.

options:
  -h, --help            show this help message and exit
  -i INPUT_FOLDERS, --input-folders INPUT_FOLDERS
                        Parent folder including all folders of files to be anonymized.
  -o OUTPUT_FOLDER, --output-folder OUTPUT_FOLDER
                        Folder where the anonymized files will be saved.
  -s DAT_SCRIPT, --dat-script DAT_SCRIPT
                        Script to be used for anonymization by the DAT.jar tool.
  --new-ids NEW_IDS     JSON file generated by pacsman-get-pseudonyms containing the mapping between the old and new patient IDs. It should in the
                        format {'old_id1': 'new_id1', 'old_id2': 'new_id2', ...}. If not provided, the script will generate a new ID randomly.
  --day-shift DAY_SHIFT
                        JSON file containing the day shift / increment to use for each patient ID. The old patient ID is the key and the day shift
                        is the value, e.g. {'old_id1': 5, 'old_id2': -3, ...}. If not provided, the script will generate a new day shift randomly.
```

### Examples

#### Basic

```bash
ctp_dat_batcher \
  -i /path/to/input/folder \
  -o /path/of/output/folder \
  -s /path/to/dat/script
```
where:
- `/path/to/input/folder` should be structured as follows:

  ```
  /path/to/input/folder
  |__ sub-<patientID1>
  |     |__ ses-<sessionDate1>
  |     |     |__ Series1-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ Series2-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ ...
  |     |__ ses-<sessionDate2>
  |     |     |__ Series1-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ Series2-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ ...
  |     |_ ...
  |__ sub-<patientID2>
  |     |__ ses-<sessionDate1>
  |     |     |__ Series1-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ Series2-Description  # Can be any name
  |     |     |     |__ 001.dcm
  |     |     |     |__ 002.dcm
  |     |     |     |__ ...
  |     |     |__ ...
  ```

- `/path/of/output/folder` will keep the same structure but the patientIDs and sessionDates will be replaced by the new IDs and Dates
- `/path/to/dat/script` should point to the anonymizer script used by DAT. The doc for the syntax can be found here: <https://mircwiki.rsna.org/index.php?title=The_CTP_DICOM_Anonymizer>

**Note:** the RSNA MIRC Clinical Trial Processor (CTP) DICOM anonymiser is the core engine. CTP doc is here: <https://mircwiki.rsna.org/index.php?title=MIRC_CTP>

## Removing potentially identifiable DICOMs

After running `ctp_dat_batcher`, you may still need to delete some files that may have burn-in patient data, such as dose reports, or visible face, 
such as T1w MPRAGEs. you can use `delete_identifiable_dicoms.py`. For convenience, a conda environment is provided in `envs/env_dev.yml` that should install all the required dependencies.
