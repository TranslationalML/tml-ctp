Usage
=====

tml_ctp_dat_batcher
-------------------
The `tml_ctp_dat_batcher` script is a wrapper for the DAT.jar (CTP DicomAnonymizerTool), streamlining the anonymization of DICOM files using Docker. 
It automates key tasks, such as generating new patient IDs and shifting dates, to ensure compliance with anonymization standards. 
The script processes an input folder of DICOM files, anonymizes them according to a specified DAT script, and saves the anonymized files to an output folder.
The anonymization script utilized by the DAT.jar tool must adhere to a specific syntax. For comprehensive details on the required script syntax, please refer to the `CTP DICOM Anonymizer Documentation <https://mircwiki.rsna.org/index.php?title=The_CTP_DICOM_Anonymizer>`_.

The command below demonstrates how to run tml_ctp_dat_batcher to anonymize DICOM file with all available options:

.. code-block:: none

    usage: tml_ctp_dat_batcher [-h] -i INPUT_FOLDERS -o OUTPUT_FOLDER -s DAT_SCRIPT 
                               [--new-ids NEW_IDS] [--day-shift DAY_SHIFT] [--image-tag IMAGE_TAG] [--version]

.. code-block:: none

    Options:
      -h, --help            Show this help message and exit.
      -i INPUT_FOLDERS, --input-folders INPUT_FOLDERS
                            Parent folder including all sub-folders of files to be anonymized.
      -o OUTPUT_FOLDER, --output-folder OUTPUT_FOLDER
                            Folder where the anonymized files will be saved.
      -s DAT_SCRIPT, --dat-script DAT_SCRIPT
                            Script to be used for anonymization by the DAT.jar tool.
      --new-ids NEW_IDS     JSON file generated by pacsman-get-pseudonyms containing the mapping between the old and new 
                            patient IDs. The format should be: {"old_id1": "new_id1", "old_id2": "new_id2", ...}. 
                            If not provided, the script will generate a new ID randomly.
      --day-shift DAY_SHIFT JSON file containing the day shift/increment for each patient ID. The format should be: 
                            {"old_id1": 5, "old_id2": -3, ...}. If not provided, the script will generate a random day shift.
      --image-tag IMAGE_TAG Tag of the Docker image to use for running DAT.jar (default: tml-ctp-anonymizer:<version>).
      --version             Show the program's version number and exit.

.. Important::

  The input folder must be organized according to the following structure:

    .. code-block:: text

        /path/to/input/folder
        ├── sub-<patientID1>
        │   ├── ses-<sessionDate1>
        │   │   ├── Series1-Description  # Can be any name
        │   │   │   ├── 001.dcm
        │   │   │   ├── 002.dcm
        │   │   │   └── ...
        │   │   ├── Series2-Description  # Can be any name
        │   │   │   ├── 001.dcm
        │   │   │   ├── 002.dcm
        │   │   │   └── ...
        │   │   └── ...
        │   └── ses-<sessionDate2>
        │       ├── Series1-Description  # Can be any name
        │       │   ├── 001.dcm
        │       │   ├── 002.dcm
        │       │   └── ...
        │       ├── Series2-Description  # Can be any name
        │       │   ├── 001.dcm
        │       │   ├── 002.dcm
        │       │   └── ...
        │       └── ...
        └── sub-<patientID2>
            └── ses-<sessionDate1>
                ├── Series1-Description  # Can be any name
                │   ├── 001.dcm
                │   ├── 002.dcm
                │   └── ...
                ├── Series2-Description  # Can be any name
                │   ├── 001.dcm
                │   ├── 002.dcm
                │   └── ...
                └── ...

    The output folder will preserve the original structure, but patient IDs and session dates will be replaced with the new anonymized IDs and dates.

.. Note::

    The RSNA MIRC Clinical Trial Processor (CTP) DICOM anonymizer operates as the underlying code within tml_ctp_dat_batcher. For more details, refer to the `CTP Documentation <https://mircwiki.rsna.org/index.php?title=MIRC_CTP>`_.

Example
--------

- **Basic Usage**:

.. code-block:: none

    tml_ctp_dat_batcher \
      -i /path/to/input/folder \
      -o /path/of/output/folder \
      -s /path/to/dat/script

tml_ctp_clean_series_tags
-------------------------

After running `tml_ctp_dat_batcher`, you may still need to ensure that any `PatientID` or `SeriesDate` tags are not present in the DICOM tags at all levels (including in sequences). The `tml_ctp_clean_series_tags` tool can be used for this purpose.

.. code-block:: bash

    usage: tml_ctp_clean_series_tags [-h] [--CTP_data_folder CTP_DATA_FOLDER] [--original_cohort ORIGINAL_COHORT] 
                                     [--ids_file IDS_FILE]

    Dangerous tags process and recursive overwrite of DICOM images.

    Options:
      -h, --help            Show this help message and exit.
      --CTP_data_folder CTP_DATA_FOLDER
                            Path to the CTP data folder.
      --original_cohort ORIGINAL_COHORT
                            Path to the original cohort folder.
      --ids_file IDS_FILE   Path to the IDs file generated by the CTP batcher.


tml_ctp_delete_identifiable_dicoms
----------------------------------

After running `tml_ctp_dat_batcher`, you may need to delete files that could lead to patient identification, such as dose reports or visible facial features in T1w MPRAGE images. Use the `tml_ctp_delete_identifiable_dicoms` script for this purpose.

.. code-block:: bash

    usage: tml_ctp_delete_identifiable_dicoms [-h] --in_folder IN_FOLDER [--delete_T1w] [--delete_T2w]

    Delete DICOM files that could lead to patient identification.

    Options:
      -h, --help            Show this help message and exit.
      --in_folder IN_FOLDER, -d IN_FOLDER
                            Root directory containing the DICOM files to be screened for identifiable data.
      --delete_T1w, -t1w    Delete potentially identifiable T1-weighted images (e.g., MPRAGE).
      --delete_T2w, -t2w    Delete potentially identifiable T2-weighted images (e.g., FLAIR).
